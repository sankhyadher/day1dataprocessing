<script>
let files = [];
let results = [];

document.getElementById("files").addEventListener("change", e => {
    files = Array.from(e.target.files);
    document.getElementById("fileInfo").textContent = files.length + " files selected";
    document.getElementById("processBtn").disabled = files.length === 0;
});


async function processAllFiles() {
    results = [];
    document.getElementById("downloadBtn").style.display = "none";

    for (let i = 0; i < files.length; i++) {
        updateProgress(i + 1, files.length);

        const data = await parseCSV(files[i]);
        const metrics = extractMetrics(files[i].name, data);
        results.push(metrics);
    }

    showResults();
    document.getElementById("downloadBtn").style.display = "inline-block";
}


function updateProgress(count, total) {
    const pct = Math.round((count / total) * 100);
    document.getElementById("progress").innerHTML =
        `<div class="progress"><div class="progress-bar" style="width:${pct}%">${pct}%</div></div>`;
}


// ------- CSV PARSER -------
function parseCSV(file) {
    return new Promise(resolve => {
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: r => resolve(r.data)
        });
    });
}


// ----------- MAIN EXTRACTION LOGIC -----------
function extractMetrics(filename, data) {

    const id = filename.replace(/\.(csv|txt)$/i, "").replace("_period_analysis_summary", "");
    const name = id;

    // FIXED ROW POSITIONS (LAST ROW REMOVED)
    const baseline = data[0];   // Baseline
    const pgq      = data[7];   // PGQ (row 7)
    
    // CONDITIONING = average of: C1 (2), C3 (4), C4 (5), C5 (6)
    const conditioningRows = [data[2], data[4], data[5], data[6]];

    // helper to average a numeric column across rows
    function avgMetric(rows, key) {
        const values = rows
            .map(r => {
                if (!r) return null;
                const col = Object.keys(r).find(k => k.toLowerCase().includes(key.toLowerCase()));
                return typeof r[col] === "number" ? r[col] : null;
            })
            .filter(v => v !== null);

        if (values.length === 0) return "N/A";
        return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(6);
    }

    const conditioning = {
        meanSCL: avgMetric(conditioningRows, "mean scl"),
        meanSCR: avgMetric(conditioningRows, "mean scr"),
        scrFreq: avgMetric(conditioningRows, "scr freq"),
        totalSCR: avgMetric(conditioningRows, "total scr"),
        sclSlope: avgMetric(conditioningRows, "scl slope"),
        nsSCL: avgMetric(conditioningRows, "ns-scl"),
        sclStd: avgMetric(conditioningRows, "scl std"),
        scrStd: avgMetric(conditioningRows, "scr std")
    };

    // Build output row object
    return {
        id,
        name,

        baseline: {
            meanSCL: baseline["Mean SCL"],
            meanSCR: baseline["Mean SCR"],
            scrFreq: baseline["SCR Frequen"],
            totalSCR: baseline["Total SCRs"],
            sclSlope: baseline["SCL Slope"],
            nsSCL: baseline["NS-SCL"],
            sclStd: baseline["SCL Std Dev"],
            scrStd: baseline["SCR Std Dev"]
        },

        conditioning: conditioning,

        pgq: {
            meanSCL: pgq["Mean SCL"],
            meanSCR: pgq["Mean SCR"],
            scrFreq: pgq["SCR Frequen"],
            totalSCR: pgq["Total SCRs"],
            sclSlope: pgq["SCL Slope"],
            nsSCL: pgq["NS-SCL"],
            sclStd: pgq["SCL Std Dev"],
            scrStd: pgq["SCR Std Dev"]
        }
    };
}


// --------- PREVIEW TABLE ---------
function showResults() {
    let html = `
    <h3>Preview (first 10 rows)</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th><th>NAME</th>
                <th>Mean SCL BASELINE</th><th>Mean SCL CONDITIONING</th><th>Mean SCL PGQ</th>
                <th>Mean SCR BASELINE</th><th>Mean SCR CONDITIONING</th><th>Mean SCR PGQ</th>
                <th>SCR Freq BASELINE</th><th>SCR Freq CONDITIONING</th><th>SCR Freq PGQ</th>
                <th>Total SCR BASELINE</th><th>Total SCR CONDITIONING</th><th>Total SCR PGQ</th>
                <th>SCL Slope BASELINE</th><th>SCL Slope CONDITIONING</th><th>SCL Slope PGQ</th>
                <th>NS-SCL BASELINE</th><th>NS-SCL CONDITIONING</th><th>NS-SCL PGQ</th>
                <th>SCL Std BASELINE</th><th>SCL Std CONDITIONING</th><th>SCL Std PGQ</th>
                <th>SCR Std BASELINE</th><th>SCR Std CONDITIONING</th><th>SCR Std PGQ</th>
            </tr>
        </thead><tbody>
    `;

    results.slice(0, 10).forEach(r => {
        html += `
        <tr>
            <td>${r.id}</td><td>${r.name}</td>

            <td>${r.baseline.meanSCL}</td><td>${r.conditioning.meanSCL}</td><td>${r.pgq.meanSCL}</td>
            <td>${r.baseline.meanSCR}</td><td>${r.conditioning.meanSCR}</td><td>${r.pgq.meanSCR}</td>
            <td>${r.baseline.scrFreq}</td><td>${r.conditioning.scrFreq}</td><td>${r.pgq.scrFreq}</td>
            <td>${r.baseline.totalSCR}</td><td>${r.conditioning.totalSCR}</td><td>${r.pgq.totalSCR}</td>
            <td>${r.baseline.sclSlope}</td><td>${r.conditioning.sclSlope}</td><td>${r.pgq.sclSlope}</td>
            <td>${r.baseline.nsSCL}</td><td>${r.conditioning.nsSCL}</td><td>${r.pgq.nsSCL}</td>
            <td>${r.baseline.sclStd}</td><td>${r.conditioning.sclStd}</td><td>${r.pgq.sclStd}</td>
            <td>${r.baseline.scrStd}</td><td>${r.conditioning.scrStd}</td><td>${r.pgq.scrStd}</td>
        </tr>`;
    });

    html += "</tbody></table>";
    document.getElementById("results").innerHTML = html;
}


// ---------- CSV EXPORT ----------
function downloadCSV() {

    const header = [
        "id","NAME",
        "Mean SCL BASELINE","Mean SCL CONDITIONING","Mean SCL PGQ",
        "Mean SCR BASELINE","Mean SCR CONDITIONING","Mean SCR PGQ",
        "SCR Freq BASELINE","SCR Freq CONDITIONING","SCR Freq PGQ",
        "Total SCR BASELINE","Total SCR CONDITIONING","Total SCR PGQ",
        "SCL Slope BASELINE","SCL Slope CONDITIONING","SCL Slope PGQ",
        "NS-SCL BASELINE","NS-SCL CONDITIONING","NS-SCL PGQ",
        "SCL Std BASELINE","SCL Std CONDITIONING","SCL Std PGQ",
        "SCR Std BASELINE","SCR Std CONDITIONING","SCR Std PGQ"
    ];

    const rows = results.map(r => [
        r.id, r.name,
        r.baseline.meanSCL, r.conditioning.meanSCL, r.pgq.meanSCL,
        r.baseline.meanSCR, r.conditioning.meanSCR, r.pgq.meanSCR,
        r.baseline.scrFreq, r.conditioning.scrFreq, r.pgq.scrFreq,
        r.baseline.totalSCR, r.conditioning.totalSCR, r.pgq.totalSCR,
        r.baseline.sclSlope, r.conditioning.sclSlope, r.pgq.sclSlope,
        r.baseline.nsSCL, r.conditioning.nsSCL, r.pgq.nsSCL,
        r.baseline.sclStd, r.conditioning.sclStd, r.pgq.sclStd,
        r.baseline.scrStd, r.conditioning.scrStd, r.pgq.scrStd
    ]);

    const csv = [header, ...rows].map(r => r.join(",")).join("\n");

    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
    link.download = "EDA_MASTER_SHEET.csv";
    link.click();
}
</script>
